(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))e(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&e(o)}).observe(document,{childList:!0,subtree:!0});function r(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function e(s){if(s.ep)return;s.ep=!0;const i=r(s);fetch(s.href,i)}})();async function T({url:n}){try{const t=await fetch(n);if(!t.ok)throw new Error;const r=await t.arrayBuffer(),e=new Blob([r],{type:"application/octet-stream"});return{success:!0,data:URL.createObjectURL(e)}}catch{return{success:!1}}}const R={cityMorphDino:"https://reel-em-in-hls-bucket.s3.us-west-1.amazonaws.com/23fa836c-65ea-47d2-80ee-10c01e2dc883/playlist.m3u8",worldRotation:"https://reel-em-in-hls-bucket.s3.us-west-1.amazonaws.com/4534bfc8-a5c5-4f1a-9c9d-a6a9d1875b43/playlist.m3u8",streetFighterWithAudio:"https://reel-em-in-hls-bucket.s3.us-west-1.amazonaws.com/bab4eed3-a93e-4dff-ae47-6a29195f2a23/playlist.m3u8"};async function S({}){try{return Promise.resolve({success:!0,data:{metadata:{id:"1",title:"Some Title"},render:{aspectRatio:1,mindUrl:"https://reel-em-in-hls-bucket.s3.us-west-1.amazonaws.com/assets/targets.mind",globalRotationLimits:{x:{min:-30,max:30},y:{min:-30,max:30},z:{min:-30,max:30}},webLinkUrl:"https://www.citymorphstudio.com",targets:[{type:"hls",data:{name:"hls1",videoUrl:R.streetFighterWithAudio,aspectRatio:1.754385965,scaleVector:{x:1.05,y:1.05,z:1}}}]}}})}catch{return Promise.resolve({success:!1})}}class k{vector;dimensions;constructor(){this.vector={x:0,y:0,z:0},this.dimensions={width:0,height:0}}update({x:t,y:r,z:e,width:s,height:i}){typeof t=="number"&&(this.vector.x=t),typeof r=="number"&&(this.vector.y=r),typeof e=="number"&&(this.vector.z=e),typeof s=="number"&&(this.dimensions.width=s),typeof i=="number"&&(this.dimensions.height=i)}getPositionString(){return`${this.vector.x} ${this.vector.y} ${this.vector.z}`}getWidthString(){return`${this.dimensions.width}`}getHeightString(){return`${this.dimensions.height}`}static updateHtmlElement(t,r){r.setAttribute("position",t.getPositionString()),r.setAttribute("width",t.getHeightString()),r.setAttribute("height",t.getHeightString())}}class L{frameCount;lastTime;fps;constructor(){this.frameCount=0,this.lastTime=0,this.fps=0}update(t){if(this.frameCount++,this.lastTime>0){const r=t-this.lastTime;r>0&&(this.fps=Math.round(1e3/r))}this.lastTime=t}get(){return{frameCount:this.frameCount,fps:this.fps}}}class U{camera;canvas;renderTargets;constructor(t){this.camera=t.camera,this.canvas=t.canvas,this.renderTargets=new Set(t.renderTargets),this.setupClickListener()}addRenderTarget(t){this.renderTargets.add(t)}setupClickListener(){this.canvas.addEventListener("click",t=>{const r=this.canvas.getBoundingClientRect(),e=new THREE.Vector2;e.x=(t.clientX-r.left)/r.width*2-1,e.y=-((t.clientY-r.top)/r.height)*2+1;const s=this.camera.getObject3D("camera");if(!s){console.warn("Camera not found");return}const i=new THREE.Raycaster;i.setFromCamera(e,s);for(const o of this.renderTargets){const d=o.getRenderObj();if(d&&d.object3D&&i.intersectObject(d.object3D,!0).length>0){o.onClick();break}}})}}class m{static seen=!1;static eventNames=Object.freeze({onMarkerFound:"onMarkerFound",onMarkerLost:"onMarkerLost",onMarkerFirstSeen:"onMarkerFirstSeen"});static emit(t,r){const e=new CustomEvent(t,{detail:r});window.dispatchEvent(e)}static onMarkerFound(t){console.log("PubSub - Marker Found"),m.seen||(m.onMarkerFirstSeen(t),m.seen=!0),m.emit(m.eventNames.onMarkerFound,t)}static onMarkerLost(t){m.emit(m.eventNames.onMarkerLost,t)}static onMarkerFirstSeen(t){m.emit(m.eventNames.onMarkerFirstSeen,t)}}const{Vector3:z,Quaternion:$,Euler:H}=THREE,M=6;class O{debug;htmlElements;flags;fpsData;markerData;cornerData;renderTargets;aFrameRayCaster;mindFileUrl;constructor({renderTargets:t,isDebugging:r,mindFileUrl:e}){this.flags={sceneStarted:!1},this.mindFileUrl=e,this.fpsData=new L,this.markerData={found:!1,current:{position:new z,scale:new z,rotation:new z,quaternion:new $,euler:new H},historic:[],average:{position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:0,y:0,z:0}}},this.cornerData={bottomLeft:new k,bottomRight:new k,topLeft:new k,topRight:new k},this.renderTargets=[...t];const{htmlElements:s,debug:i}=this.createScene(r);this.htmlElements=s,this.debug=i,AFRAME.registerComponent("frame-scene",{init:this.init.bind(this),tick:this.tick.bind(this)})}createScene(t){const r=document.querySelector("body");if(r===null)throw new Error("Body cannot be null");const e=document.createElement("a-scene");e.setAttribute("id","scene"),e.setAttribute("frame-scene",""),e.setAttribute("mindar-image",`imageTargetSrc: ${this.mindFileUrl}`),e.setAttribute("vr-mode-ui","enabled: false"),e.setAttribute("device-orientation-permission-ui","enabled: false");const s=document.createElement("a-assets");this.renderTargets.map(a=>a.createAssets()).flat().filter(a=>a!==void 0)?.forEach(a=>s.appendChild(a));const o=document.createElement("a-camera");o.setAttribute("position","0 0 0"),o.setAttribute("look-controls","enabled: false");const d=document.createElement("a-entity");d.setAttribute("id","marker"),d.setAttribute("mindar-image-target","targetIndex: 0");const c=this.renderTargets.map(a=>a.createAFrameElement());e.appendChild(s),e.appendChild(o),e.appendChild(d),c.forEach(a=>e.appendChild(a));const l={camera:o,marker:d,scene:e};let h={isDebugging:!1};if(t){const a=document.createElement("a-plane");a.setAttribute("id","topLeft"),a.setAttribute("position","10000 10000 10000"),a.setAttribute("width","1"),a.setAttribute("height","1"),a.setAttribute("color","red");const u=document.createElement("a-plane");u.setAttribute("id","topRight"),u.setAttribute("position","10000 10000 10000"),u.setAttribute("width","1"),u.setAttribute("height","1"),u.setAttribute("color","green");const p=document.createElement("a-plane");p.setAttribute("id","bottomLeft"),p.setAttribute("position","10000 10000 10000"),p.setAttribute("width","1"),p.setAttribute("height","1"),p.setAttribute("color","blue");const f=document.createElement("a-plane");f.setAttribute("id","bottomRight"),f.setAttribute("position","10000 10000 10000"),f.setAttribute("width","1"),f.setAttribute("height","1"),f.setAttribute("color","yellow");const g=document.createElement("div");g.setAttribute("id","dev-tools"),g.setAttribute("data-show-status","showing");const x=document.createElement("button");x.setAttribute("id","dev-tools-show-hide-btn"),x.textContent="Hide Dev Tools";const w=document.createElement("div");w.setAttribute("id","notice-board-misc"),w.setAttribute("class","notice-board-div");const D=document.createElement("ul");D.setAttribute("class","notice-board");const y=document.createElement("li");y.setAttribute("id","notice-marker-found"),y.setAttribute("data-status","bad"),y.textContent="Marker Lost";const C=document.createElement("li");C.setAttribute("id","notice-fps-display"),C.textContent="FPS: -",D.appendChild(y),D.appendChild(C),w.appendChild(D);const E=document.createElement("div");E.setAttribute("id","notice-board-marker"),E.setAttribute("class","notice-board-div");const b=document.createElement("ul");b.setAttribute("class","notice-board"),b.setAttribute("data-show-status","showing");const v=document.createElement("li");v.setAttribute("id","notice-marker-position"),v.textContent="Pos: -";const A=document.createElement("li");A.setAttribute("id","notice-marker-rotation"),A.textContent="Rot: -";const F=document.createElement("li");F.setAttribute("id","notice-marker-scale"),F.textContent="Scl: -",b.appendChild(v),b.appendChild(A),b.appendChild(F),E.appendChild(b),g.appendChild(x),g.appendChild(w),g.appendChild(E),e.append(a),e.append(u),e.append(p),e.append(f),r.append(g),h={isDebugging:!0,elements:{fps:{display:C,foundMarker:y},marker:{position:v,rotation:A,scale:F},corners:{bottomLeft:p,bottomRight:f,topLeft:a,topRight:u},devTools:g,showHideBtn:x}}}return r.append(e),{htmlElements:l,debug:h}}init(){if(this.renderTargets.forEach(t=>t.init()),this.registerArEvents(),this.debug.isDebugging&&this.registerDevToolEvents(),this.aFrameRayCaster===void 0){const t=document.querySelector("canvas.a-canvas");t&&t instanceof HTMLCanvasElement&&(this.aFrameRayCaster=new U({camera:this.htmlElements.camera,canvas:t,renderTargets:this.renderTargets}))}}tick(t,r){this.fpsData.update(t),this.tickUpdateScreenCornerData(),this.tickUpdateMarkerData(),this.tickUpdateScreenCornerHtml(),this.tickUpdateDevToolsFpsCounter(),this.tickUpdateDevToolsMarkerDisplay(),this.renderTargets.forEach(e=>e.tickUpdate({corners:this.cornerData,marker:this.markerData}))}registerDevToolEvents(){if(this.debug.isDebugging){const{devTools:t,showHideBtn:r}=this.debug.elements;r.addEventListener("click",()=>{t.getAttribute("data-show-status")==="showing"?(t.setAttribute("data-show-status","hidden"),r.textContent="Show Dev Tools"):(t.setAttribute("data-show-status","showing"),r.textContent="Hide Dev Tools")})}}registerArEvents(){const{scene:t,marker:r}=this.htmlElements;t.addEventListener("arReady",()=>{this.syncCameraProperties()}),r.addEventListener("targetFound",()=>{this.markerData.found=!0,this.flags.sceneStarted||(this.flags.sceneStarted=!0,document.querySelector(".mindar-ui-scanning")?.remove()),this.debug.isDebugging&&(this.debug.elements.fps.foundMarker.textContent="Marker Found",this.debug.elements.fps.foundMarker.setAttribute("data-status","good"));const e={marker:this.markerData,corners:this.cornerData};m.onMarkerFound(e)}),r.addEventListener("targetLost",()=>{this.markerData.found=!1,this.debug.isDebugging&&(this.debug.elements.fps.foundMarker.textContent="Marker Lost",this.debug.elements.fps.foundMarker.setAttribute("data-status","bad"));const e={marker:this.markerData,corners:this.cornerData};m.onMarkerLost(e)})}syncCameraProperties(){const{camera:t}=this.htmlElements,r=this.getThreeCameraEntityValues();t.setAttribute("camera",{fov:r.fov,near:r.near,far:r.far})}tickUpdateMarkerData(){if(this.markerData.found){const t=this.htmlElements.marker.object3D;t.updateMatrixWorld(!0);const{position:r,rotation:e,scale:s,euler:i,quaternion:o}=this.markerData.current;t.matrixWorld.decompose(r,o,s),i.setFromQuaternion(o,"XYZ");const d=AFRAME.THREE.MathUtils.radToDeg;if(e.x=d(i.x),e.y=d(i.y),e.z=d(i.z),this.markerData.historic.push({position:{x:r.x,y:r.y,z:r.z},rotation:{x:e.x,y:e.y,z:e.z},scale:{x:s.x,y:s.y,z:s.z}}),this.markerData.historic.length>M&&(this.markerData.historic=this.markerData.historic.slice(-M,this.markerData.historic.length)),this.markerData.historic.length>0){const c=this.markerData.historic.reduce((h,a)=>(h.position.x+=a.position.x,h.position.y+=a.position.y,h.position.z+=a.position.z,h.rotation.x+=a.rotation.x,h.rotation.y+=a.rotation.y,h.rotation.z+=a.rotation.z,h.scale.x+=a.scale.x,h.scale.y+=a.scale.y,h.scale.z+=a.scale.z,h),{position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:0,y:0,z:0}}),l=this.markerData.historic.length;c.position.x/=l,c.position.y/=l,c.position.z/=l,c.rotation.x/=l,c.rotation.y/=l,c.rotation.z/=l,c.scale.x/=l,c.scale.y/=l,c.scale.z/=l,this.markerData.average=c}}}tickUpdateScreenCornerHtml(){this.debug.isDebugging&&Object.entries(this.debug.elements.corners).forEach(([t,r])=>{k.updateHtmlElement(this.cornerData[t],r)})}tickUpdateScreenCornerData(){const{zDistance:t,halfHeight:r,halfWidth:e}=this.calculateScreenCorners();this.cornerData.topLeft.update({x:-e,y:r,z:t,width:1,height:1}),this.cornerData.topRight.update({x:e,y:r,z:t,width:1,height:1}),this.cornerData.bottomLeft.update({x:-e,y:-r,z:t,width:1,height:1}),this.cornerData.bottomRight.update({x:e,y:-r,z:t,width:1,height:1})}tickUpdateDevToolsFpsCounter(){this.debug.isDebugging&&(this.debug.elements.fps.display.textContent=`FPS: ${this.fpsData.get().fps}`)}tickUpdateDevToolsMarkerDisplay(){if(this.debug.isDebugging){const{position:t,rotation:r,scale:e}=this.debug.elements.marker;if(this.markerData.found)t.textContent=`Pos: {x: ${this.markerData.current.position.x.toFixed(1)}, y: ${this.markerData.current.position.y.toFixed(1)}, z: ${this.markerData.current.position.z.toFixed(1)}}`,r.textContent=`Rot: {x: ${this.markerData.current.rotation.x.toFixed(1)}°, y: ${this.markerData.current.rotation.y.toFixed(1)}°, z: ${this.markerData.current.rotation.z.toFixed(1)}°}`,e.textContent=`Scl: {x: ${this.markerData.current.scale.x.toFixed(1)}, y: ${this.markerData.current.scale.y.toFixed(1)}, z: ${this.markerData.current.scale.z.toFixed(1)}}`;else{const s=this.markerData.historic[0];s?(t.textContent=`Pos: {x: ${s.position.x.toFixed(1)}, y: ${s.position.y.toFixed(1)}, z: ${s.position.z.toFixed(1)}}`,r.textContent=`Rot: {x: ${s.rotation.x.toFixed(1)}°, y: ${s.rotation.y.toFixed(1)}°, z: ${s.rotation.z.toFixed(1)}°}`,e.textContent=`Scl: {x: ${s.scale.x.toFixed(1)}, y: ${s.scale.y.toFixed(1)}, z: ${s.scale.z.toFixed(1)}}`):(t.textContent="Pos: {x: ???, y: ???, z: ???}",r.textContent="Rot: {x: ???°, y: ???°, z: ???°}",e.textContent="Scl: {x: ???, y: ???, z: ???}")}}}getThreeCameraEntityValues(){const{camera:t}=this.htmlElements,{object3D:r}=t;if(r.children.length===0)throw new Error("#camera.object3d children is 0");const e=r.children[0];if(!("near"in e)||!("far"in e)||!("fov"in e)||!("aspect"in e)||typeof e.near!="number"||typeof e.far!="number"||typeof e.fov!="number"||typeof e.aspect!="number")throw new Error("threeCamera must be instance of PerspectiveCamera");return{near:e.near,far:e.far,fov:e.fov,aspect:e.aspect}}calculateScreenCorners(){const t=this.getThreeCameraEntityValues(),{near:r,fov:e,aspect:s}=t,i=-r,o=e/2*(Math.PI/180),d=Math.tan(o),c=r*d,l=c*s;return{zDistance:i,halfHeight:c,halfWidth:l}}}function j(){const n=new URL(window.location.href);return console.log(n.host),console.log(n.hostname),console.log(n.pathname),console.log(n.origin),console.log(n.port),console.log(n.hash),console.log(n.href),console.log(n.search),console.log(n.searchParams),{base:"",params:{}}}async function P(){try{const n=j(),t=await S({decomposedUrlData:n});if(!t.success)throw new Error("Unable to retrieve site configuration");const r=await T({url:t.data.render.mindUrl});if(!r.success)throw new Error("Unable to retrive site mindfile url");const e=r.data;new O({isDebugging:!1,renderTargets:[],mindFileUrl:e})}catch(n){console.error(n)}}P();
